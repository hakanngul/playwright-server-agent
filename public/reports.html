<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Raporları - Playwright Server Agent</title>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts - Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #6200ee;
            --primary-variant: #3700b3;
            --secondary-color: #03dac6;
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --error-color: #b00020;
            --text-primary: rgba(0, 0, 0, 0.87);
            --text-secondary: rgba(0, 0, 0, 0.6);
            --text-hint: rgba(0, 0, 0, 0.38);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            padding-top: 80px;
            padding-bottom: 40px;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 500;
            color: white !important;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
        }

        .nav-link.active {
            color: white !important;
        }

        .card {
            margin-bottom: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            background-color: var(--surface-color);
            border: none;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .card-header {
            font-weight: 500;
            background-color: var(--surface-color);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 16px 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .card-header .material-icons {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .badge-success {
            background-color: #4caf50;
            color: white;
        }

        .badge-danger {
            background-color: #f44336;
            color: white;
        }

        .badge-warning {
            background-color: #ff9800;
            color: white;
        }

        .badge-info {
            background-color: #2196f3;
            color: white;
        }

        .priority-high {
            background-color: #f44336;
            color: white;
        }

        .priority-medium {
            background-color: #ff9800;
            color: white;
        }

        .priority-low {
            background-color: #4caf50;
            color: white;
        }

        .test-result-success {
            border-left: 5px solid #4caf50;
        }

        .test-result-failed {
            border-left: 5px solid #f44336;
        }

        .test-result-pending {
            border-left: 5px solid #ff9800;
        }

        .refresh-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background-color: var(--primary-variant);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .refresh-btn .material-icons {
            font-size: 24px;
        }

        .step-details {
            margin-top: 10px;
            padding: 16px;
            background-color: var(--surface-color);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .step-success {
            border-left: 4px solid #4caf50;
        }

        .step-failed {
            border-left: 4px solid #f44336;
        }

        .performance-metric {
            font-size: 2rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .test-category {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 16px;
            margin-right: 5px;
        }

        .category-functional {
            background-color: #2196f3;
            color: white;
        }

        .category-regression {
            background-color: #673ab7;
            color: white;
        }

        .category-performance {
            background-color: #ff9800;
            color: white;
        }

        .category-critical {
            background-color: #f44336;
            color: white;
        }

        .category-default {
            background-color: #9e9e9e;
            color: white;
        }

        .last-updated {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .table {
            color: var(--text-primary);
        }

        .table th {
            font-weight: 500;
            color: var(--text-secondary);
            border-top: none;
            border-bottom-width: 1px;
        }

        .table td {
            border-color: rgba(0, 0, 0, 0.05);
            vertical-align: middle;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px 16px;
            background-color: var(--surface-color);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(98, 0, 238, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: var(--primary-variant);
            border-color: var(--primary-variant);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-info {
            background-color: #2196f3;
            border-color: #2196f3;
            color: white;
        }

        .btn-info:hover {
            background-color: #0d8bf2;
            border-color: #0d8bf2;
            color: white;
        }



        .modal-content {
            background-color: var(--surface-color);
            color: var(--text-primary);
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 16px 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 16px 24px;
        }


    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="material-icons align-middle me-2">theater_comedy</i>
                Playwright Server Agent
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="material-icons align-middle me-1">dashboard</i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reports.html">
                            <i class="material-icons align-middle me-1">assessment</i>
                            Test Raporları
                        </a>
                    </li>
                </ul>

            </div>
        </div>
    </nav>

    <div class="container">

        <div class="mt-4 mb-4">
            <h1 class="mb-3">Test Raporları</h1>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="material-icons">filter_list</i>
                    <span>Rapor Seçenekleri</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="row g-2">
                                <div class="col-6 col-sm-4">
                                    <label for="reportPeriod" class="form-label">Dönem</label>
                                    <select class="form-select" id="reportPeriod">
                                        <option value="daily" selected>Günlük</option>
                                        <option value="weekly">Haftalık</option>
                                        <option value="monthly">Aylık</option>
                                    </select>
                                </div>
                                <div class="col-6 col-sm-4">
                                    <label for="reportDate" class="form-label">Tarih</label>
                                    <input type="date" class="form-control" id="reportDate">
                                </div>
                                <div class="col-12 col-sm-4 d-flex align-items-end">
                                    <button id="loadReportsBtn" class="btn btn-primary w-100">
                                        <i class="material-icons align-middle me-1">download</i>
                                        Raporları Yükle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="last-updated" class="last-updated mb-3"></div>

        <!-- Test Sonuçları Özeti -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="material-icons">pie_chart</i>
                        <span>Test Sonuçları Özeti</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="test-results-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="material-icons">category</i>
                        <span>Kategori Dağılımı</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Süresi ve Performans -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="material-icons">timer</i>
                        <span>Test Süresi Dağılımı</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="duration-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="material-icons">speed</i>
                        <span>Performans Metrikleri</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 text-center mb-3">
                                <div class="performance-metric" id="avg-duration">-</div>
                                <div class="metric-label">Ortalama Test Süresi</div>
                            </div>
                            <div class="col-md-6 text-center mb-3">
                                <div class="performance-metric" id="success-rate">-</div>
                                <div class="metric-label">Başarı Oranı</div>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="performance-metric" id="total-tests">-</div>
                                <div class="metric-label">Toplam Test</div>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="performance-metric" id="avg-steps">-</div>
                                <div class="metric-label">Ortalama Adım Sayısı</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtre Seçenekleri -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="material-icons">filter_list</i>
                <span>Filtreler</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filterBrowser" class="form-label">Tarayıcı</label>
                        <select class="form-select" id="filterBrowser">
                            <option value="all" selected>Tümü</option>
                            <option value="chromium">Chromium</option>
                            <option value="firefox">Firefox</option>
                            <option value="webkit">WebKit</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filterCategory" class="form-label">Kategori</label>
                        <select class="form-select" id="filterCategory">
                            <option value="all" selected>Tümü</option>
                            <option value="functional">Fonksiyonel</option>
                            <option value="regression">Regresyon</option>
                            <option value="performance">Performans</option>
                            <option value="critical">Kritik</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filterStatus" class="form-label">Durum</label>
                        <select class="form-select" id="filterStatus">
                            <option value="all" selected>Tümü</option>
                            <option value="completed">Başarılı</option>
                            <option value="failed">Başarısız</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="sortBy" class="form-label">Sıralama</label>
                        <select class="form-select" id="sortBy">
                            <option value="date-desc" selected>Tarih (Yeni-Eski)</option>
                            <option value="date-asc">Tarih (Eski-Yeni)</option>
                            <option value="duration-asc">Süre (Kısa-Uzun)</option>
                            <option value="duration-desc">Süre (Uzun-Kısa)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tamamlanan Testler -->
        <div class="card">
            <div class="card-header">
                <i class="material-icons">history</i>
                <span>Tamamlanan Testler</span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <label for="page-size-select" class="me-3">Sayfa başına gösterim:</label>
                        <select id="page-size-select" class="form-select form-select-sm d-inline-block" style="width: 70px;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="input-group w-25">
                        <input type="text" id="search-input" class="form-control" placeholder="Ara...">
                        <button class="btn btn-outline-secondary" type="button" id="search-button">
                            <i class="material-icons">search</i>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="completed-tests-table" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Test Adı</th>
                                <th>Kategori</th>
                                <th>Tarayıcı</th>
                                <th>Durum</th>
                                <th>Süre</th>
                                <th>Tamamlanma Zamanı</th>
                                <th>Detaylar</th>
                            </tr>
                        </thead>
                        <tbody id="completed-tests-tbody">
                            <!-- Tamamlanan testler burada listelenecek -->
                            <tr>
                                <td colspan="7" class="text-center">Henüz tamamlanan test yok</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span id="pagination-info">Gösterilen: 0-0 / 0</span>
                    </div>
                    <nav aria-label="Sayfalama">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prev-page" aria-label="Önceki">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="next-page" aria-label="Sonraki">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Test Detayları Modal -->
        <div class="modal fade" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="testDetailsModalLabel">
                            <i class="material-icons align-middle me-1">assignment</i>
                            Test Detayları
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="testDetailsContent">
                        <!-- Test detayları burada gösterilecek -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        <button type="button" class="btn btn-primary" id="downloadReportBtn">
                            <i class="material-icons align-middle me-1">download</i>
                            Raporu İndir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button id="refresh-btn" class="refresh-btn">
        <i class="material-icons">refresh</i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>


        // Test sonuçlarını saklayacak dizi
        let completedTests = [];
        let filteredTests = [];

        // Socket.io bağlantısı
        const socket = io();

        // Socket.io olayları
        socket.on('connect', () => {
            console.log('Socket.io bağlantısı kuruldu');
            updateLastUpdated();
        });

        socket.on('welcome', (data) => {
            console.log('Server mesajı:', data.message);
        });

        socket.on('request:completed', (data) => {
            console.log('Test tamamlandı:', data);
            // Tamamlanan testi listeye ekle
            completedTests.unshift(data);
            // Maksimum 100 test sakla
            if (completedTests.length > 100) {
                completedTests.pop();
            }
            // Tabloyu ve grafikleri güncelle
            applyFilters();
            updateCharts();
            updatePerformanceMetrics();
            updateLastUpdated();
        });

        socket.on('request:failed', (data) => {
            console.log('Test başarısız:', data);
            // Başarısız testi listeye ekle
            completedTests.unshift(data);
            // Maksimum 100 test sakla
            if (completedTests.length > 100) {
                completedTests.pop();
            }
            // Tabloyu ve grafikleri güncelle
            applyFilters();
            updateCharts();
            updatePerformanceMetrics();
            updateLastUpdated();
        });

        // Tarih formatı fonksiyonu
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('tr-TR');
        }

        // Süre formatı fonksiyonu
        function formatDuration(ms) {
            if (!ms) return '0s';

            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) return `${seconds}s`;

            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        // Test süresini hesaplama fonksiyonu
        function calculateTestDuration(test) {
            if (!test.completedAt || !test.startedAt) return 0;

            const startTime = new Date(test.startedAt).getTime();
            const endTime = new Date(test.completedAt).getTime();
            return endTime - startTime;
        }

        // Kategori rengini belirleme fonksiyonu
        function getCategoryClass(category) {
            switch (category) {
                case 'functional': return 'category-functional';
                case 'regression': return 'category-regression';
                case 'performance': return 'category-performance';
                case 'critical': return 'category-critical';
                default: return 'category-default';
            }
        }

        // Kategori rengini hex olarak al
        function getCategoryColor(category) {
            switch (category) {
                case 'functional': return '#007bff';
                case 'regression': return '#6f42c1';
                case 'performance': return '#fd7e14';
                case 'critical': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // Filtreleri uygulama fonksiyonu
        function applyFilters() {
            const browserFilter = document.getElementById('filterBrowser').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;

            // Filtreleme
            filteredTests = completedTests.filter(test => {
                // Tarayıcı filtresi
                if (browserFilter !== 'all' && test.testPlan.browserPreference !== browserFilter) {
                    return false;
                }

                // Kategori filtresi
                if (categoryFilter !== 'all' && (test.testPlan.category || 'default') !== categoryFilter) {
                    return false;
                }

                // Durum filtresi
                if (statusFilter !== 'all' && test.status !== statusFilter) {
                    return false;
                }

                return true;
            });

            // Sıralama
            filteredTests.sort((a, b) => {
                const durationA = calculateTestDuration(a);
                const durationB = calculateTestDuration(b);
                const dateA = new Date(a.completedAt || 0).getTime();
                const dateB = new Date(b.completedAt || 0).getTime();

                switch (sortBy) {
                    case 'date-desc':
                        return dateB - dateA;
                    case 'date-asc':
                        return dateA - dateB;
                    case 'duration-asc':
                        return durationA - durationB;
                    case 'duration-desc':
                        return durationB - durationA;
                    default:
                        return dateB - dateA;
                }
            });

            updateCompletedTestsTable();
        }

        // Tamamlanan testler tablosunu güncelleme
        function updateCompletedTestsTable() {
            // DataTable'ı temizle ve yeniden oluştur
            if ($.fn.DataTable.isDataTable('#completed-tests-datatable')) {
                $('#completed-tests-datatable').DataTable().destroy();
            }

            const tableData = [];

            // Tablo verilerini hazırla
            filteredTests.forEach((test, index) => {
                const isSuccess = test.status === 'completed';
                const testDuration = calculateTestDuration(test);
                const category = test.testPlan.category || 'default';
                const originalIndex = completedTests.indexOf(test);

                tableData.push([
                    test.testPlan.name,
                    `<span class="test-category ${getCategoryClass(category)}">${category}</span>`,
                    test.testPlan.browserPreference || 'chromium',
                    `<span class="badge ${isSuccess ? 'badge-success' : 'badge-danger'}">${isSuccess ? 'Başarılı' : 'Başarısız'}</span>`,
                    formatDuration(testDuration),
                    formatDate(test.completedAt),
                    `<button class="btn btn-sm btn-info" onclick="showTestDetails(${originalIndex})">Detaylar</button>`
                ]);
            });

            // DataTable'ı oluştur
            $('#completed-tests-datatable').DataTable({
                data: tableData,
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/tr.json'
                },
                order: [[5, 'desc']], // Tamamlanma zamanına göre sırala (en son en üstte)
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                columnDefs: [
                    { className: "text-center", targets: [2, 3, 4, 6] }
                ]
            });
        }

        // Test detaylarını gösterme
        function showTestDetails(index) {
            const test = completedTests[index];
            const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
            const modalContent = document.getElementById('testDetailsContent');

            const isSuccess = test.status === 'completed';
            const testDuration = calculateTestDuration(test);
            const category = test.testPlan.category || 'default';

            let stepsHtml = '';
            if (test.result && test.result.steps) {
                test.result.steps.forEach((step, stepIndex) => {
                    const stepSuccess = step.success !== false;
                    stepsHtml += `
                        <div class="step-details ${stepSuccess ? 'step-success' : 'step-failed'} mb-2">
                            <div><strong>Adım ${stepIndex + 1}:</strong> ${step.description || step.action}</div>
                            <div><strong>Eylem:</strong> ${step.action}</div>
                            <div><strong>Hedef:</strong> ${step.target}</div>
                            <div><strong>Değer:</strong> ${step.value || '-'}</div>
                            <div><strong>Durum:</strong> <span class="badge ${stepSuccess ? 'badge-success' : 'badge-danger'}">${stepSuccess ? 'Başarılı' : 'Başarısız'}</span></div>
                            ${step.error ? `<div><strong>Hata:</strong> ${step.error}</div>` : ''}
                            ${step.screenshot ? `<div class="mt-2"><img src="${step.screenshot}" class="img-fluid" alt="Adım Ekran Görüntüsü"></div>` : ''}
                        </div>
                    `;
                });
            } else if (test.error) {
                stepsHtml = `
                    <div class="alert alert-danger">
                        <strong>Hata:</strong> ${test.error.message}
                        ${test.error.stack ? `<pre>${test.error.stack}</pre>` : ''}
                    </div>
                `;
            }

            modalContent.innerHTML = `
                <div class="card ${isSuccess ? 'test-result-success' : 'test-result-failed'} mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${test.testPlan.name}</h5>
                        <div class="mb-3">
                            <span class="test-category ${getCategoryClass(category)}">${category}</span>
                            <span class="badge ${isSuccess ? 'badge-success' : 'badge-danger'}">${isSuccess ? 'Başarılı' : 'Başarısız'}</span>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Tarayıcı:</strong> ${test.testPlan.browserPreference || 'chromium'}
                            </div>
                            <div class="col-md-6">
                                <strong>Süre:</strong> ${formatDuration(testDuration)}
                            </div>
                            <div class="col-md-6">
                                <strong>Başlangıç:</strong> ${formatDate(test.startedAt)}
                            </div>
                            <div class="col-md-6">
                                <strong>Bitiş:</strong> ${formatDate(test.completedAt)}
                            </div>
                        </div>
                        <h6>Test Adımları:</h6>
                        ${stepsHtml}
                    </div>
                </div>
            `;

            modal.show();
        }

        // Grafikleri güncelleme
        function updateCharts() {
            updateTestResultsChart();
            updateCategoryChart();
            updateDurationChart();
        }

        // Test sonuçları grafiğini güncelleme
        function updateTestResultsChart() {
            const ctx = document.getElementById('test-results-chart').getContext('2d');

            // Başarılı ve başarısız test sayılarını hesapla
            const successCount = completedTests.filter(test => test.status === 'completed').length;
            const failedCount = completedTests.filter(test => test.status === 'failed').length;

            // Eğer grafik zaten oluşturulmuşsa güncelle, yoksa yeni oluştur
            if (window.testResultsChart) {
                window.testResultsChart.data.datasets[0].data = [successCount, failedCount];
                window.testResultsChart.update();
            } else {
                window.testResultsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Başarılı', 'Başarısız'],
                        datasets: [{
                            data: [successCount, failedCount],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Test Sonuçları'
                            }
                        }
                    }
                });
            }
        }

        // Kategori grafiğini güncelleme
        function updateCategoryChart() {
            const ctx = document.getElementById('category-chart').getContext('2d');

            // Kategorilere göre test sayılarını hesapla
            const categories = {};
            completedTests.forEach(test => {
                const category = test.testPlan.category || 'default';
                categories[category] = (categories[category] || 0) + 1;
            });

            const categoryLabels = Object.keys(categories);
            const categoryData = Object.values(categories);
            const categoryColors = categoryLabels.map(category => {
                switch (category) {
                    case 'functional': return '#007bff';
                    case 'regression': return '#6f42c1';
                    case 'performance': return '#fd7e14';
                    case 'critical': return '#dc3545';
                    default: return '#6c757d';
                }
            });

            // Eğer grafik zaten oluşturulmuşsa güncelle, yoksa yeni oluştur
            if (window.categoryChart) {
                window.categoryChart.data.labels = categoryLabels;
                window.categoryChart.data.datasets[0].data = categoryData;
                window.categoryChart.data.datasets[0].backgroundColor = categoryColors;
                window.categoryChart.update();
            } else {
                window.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: categoryColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Kategori Dağılımı'
                            }
                        }
                    }
                });
            }
        }

        // Süre grafiğini güncelleme
        function updateDurationChart() {
            const ctx = document.getElementById('duration-chart').getContext('2d');

            // Test sürelerini hesapla
            const durations = completedTests.map(test => {
                return {
                    name: test.testPlan.name,
                    duration: calculateTestDuration(test),
                    success: test.status === 'completed'
                };
            });

            // En son 10 testi al
            const recentTests = durations.slice(0, 10).reverse();

            // Eğer grafik zaten oluşturulmuşsa güncelle, yoksa yeni oluştur
            if (window.durationChart) {
                window.durationChart.data.labels = recentTests.map(test => test.name);
                window.durationChart.data.datasets[0].data = recentTests.map(test => test.duration / 1000);
                window.durationChart.data.datasets[0].backgroundColor = recentTests.map(test => test.success ? '#28a745' : '#dc3545');
                window.durationChart.update();
            } else {
                window.durationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: recentTests.map(test => test.name),
                        datasets: [{
                            label: 'Test Süresi (saniye)',
                            data: recentTests.map(test => test.duration / 1000),
                            backgroundColor: recentTests.map(test => test.success ? '#28a745' : '#dc3545'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Süre (saniye)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Test Adı'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Son 10 Test Süresi'
                            }
                        }
                    }
                });
            }
        }

        // Performans metriklerini güncelleme
        function updatePerformanceMetrics() {
            // Toplam test sayısı
            document.getElementById('total-tests').textContent = completedTests.length;

            // Başarı oranı
            const successCount = completedTests.filter(test => test.status === 'completed').length;
            const successRate = completedTests.length > 0 ? (successCount / completedTests.length * 100).toFixed(1) + '%' : '-';
            document.getElementById('success-rate').textContent = successRate;

            // Ortalama test süresi
            const durations = completedTests.map(test => calculateTestDuration(test));
            const avgDuration = durations.length > 0 ? formatDuration(durations.reduce((a, b) => a + b, 0) / durations.length) : '-';
            document.getElementById('avg-duration').textContent = avgDuration;

            // Ortalama adım sayısı
            let totalSteps = 0;
            let testsWithSteps = 0;
            completedTests.forEach(test => {
                if (test.result && test.result.steps) {
                    totalSteps += test.result.steps.length;
                    testsWithSteps++;
                }
            });
            const avgSteps = testsWithSteps > 0 ? (totalSteps / testsWithSteps).toFixed(1) : '-';
            document.getElementById('avg-steps').textContent = avgSteps;
        }

        // Son güncelleme zamanını güncelleme
        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = `Son Güncelleme: ${formatDate(new Date())}`;
        }

        // Belirli bir dönem ve tarihteki verileri al
        async function fetchReportsByDate(date, period = 'daily') {
            try {
                // Önce agent sisteminden tamamlanan testleri al
                const completedResponse = await fetch('/api/agent/completed-requests');
                const completedData = await completedResponse.json();

                let agentTests = [];
                if (completedData.success) {
                    agentTests = completedData.requests;
                }

                // Sonra reports API'sinden seçilen dönem için raporları al
                const reportsResponse = await fetch(`/api/reports?period=${period}&date=${date}`);
                const reportsData = await reportsResponse.json();

                // Seçilen dönem için özeti de al
                const summaryResponse = await fetch(`/api/reports/summary/${period}?date=${date}`);
                const summaryData = await summaryResponse.json();

                // Tüm mevcut günlük raporları al
                const dailySummariesResponse = await fetch('/api/reports/summaries/daily');
                const dailySummaries = await dailySummariesResponse.json();

                // Agent testlerini ve raporları birleştir
                let allTests = [...agentTests];

                // Raporları agent formatına dönüştür ve ekle
                if (reportsData && reportsData.length > 0) {
                    const reportTests = reportsData.map(report => {
                        return {
                            id: report.id,
                            status: report.success ? 'completed' : 'failed',
                            testPlan: {
                                name: report.name,
                                description: report.description,
                                browserPreference: report.browserType,
                                category: report.tags && report.tags.length > 0 ? report.tags[0] : 'default'
                            },
                            startedAt: report.timestamp ? new Date(new Date(report.timestamp).getTime() - report.duration).toISOString() : null,
                            completedAt: report.timestamp,
                            result: {
                                steps: report.steps
                            },
                            error: report.error
                        };
                    });

                    // Duplicate ID'leri önlemek için agent testlerinde olmayan raporları ekle
                    const existingIds = new Set(allTests.map(test => test.id));
                    for (const test of reportTests) {
                        if (!existingIds.has(test.id)) {
                            allTests.push(test);
                            existingIds.add(test.id);
                        }
                    }
                }

                // Tamamlanma zamanına göre sırala (en son tamamlanan en üstte)
                allTests.sort((a, b) => {
                    return new Date(b.completedAt || 0) - new Date(a.completedAt || 0);
                });

                // Tüm testleri güncelle
                completedTests = allTests;

                // Arayüzü güncelle
                updateCompletedTestsTable();
                updateCharts();
                updatePerformanceMetrics();
                updateLastUpdated();

                // Özet bilgilerini göster
                if (summaryData) {
                    document.getElementById('total-tests').textContent = summaryData.totalTests || completedTests.length;
                    document.getElementById('success-rate').textContent = summaryData.successRate ? `${summaryData.successRate.toFixed(1)}%` : '-';
                    document.getElementById('avg-duration').textContent = summaryData.averageDuration ? formatDuration(summaryData.averageDuration) : '-';
                }

                // Günlük raporları konsola yazdır (debug için)
                console.log('Günlük raporlar:', dailySummaries);

            } catch (error) {
                console.error('Veri alınırken hata oluştu:', error);
            }
        }

        // Bugünün tarihini al
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Tüm raporları saklayacak dizi
        let allReports = [];
        // Filtrelenmiş raporları saklayacak dizi
        let filteredReports = [];
        // Sayfalama değişkenleri
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;

        // Günlük raporları tablo olarak göster
        async function loadDailyReportsTable() {
            try {
                // Tüm günlük raporları al
                const dailySummariesResponse = await fetch('/api/reports/summaries/daily');
                const dailySummaries = await dailySummariesResponse.json();

                allReports = [];

                // Her günlük rapor için
                for (const summary of dailySummaries) {
                    // Raporları al
                    const reportsResponse = await fetch(`/api/reports?period=daily&date=${summary.date}`);
                    const reports = await reportsResponse.json();

                    // Tüm raporları birleştir
                    allReports = allReports.concat(reports);
                }

                // Raporları tarihe göre sırala (en son en üstte)
                allReports.sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });

                // Filtrelenmiş raporları güncelle
                filteredReports = [...allReports];

                // Sayfalama bilgilerini güncelle
                updatePagination();

                // Tabloyu güncelle
                updateTable();

                // Özet bilgilerini güncelle
                updateChartsFromSummaries(dailySummaries);

            } catch (error) {
                console.error('Günlük raporlar yüklenirken hata oluştu:', error);
            }
        }

        // Tabloyu güncelle
        function updateTable() {
            // Tablo içeriğini temizle
            const tableBody = document.getElementById('completed-tests-tbody');
            tableBody.innerHTML = '';

            // Eğer rapor yoksa mesaj göster
            if (filteredReports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Filtrelere uygun test bulunamadı</td></tr>';
                return;
            }

            // Sayfa için başlangıç ve bitiş indekslerini hesapla
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredReports.length);

            // Sayfa bilgisini güncelle
            document.getElementById('pagination-info').textContent = `Gösterilen: ${startIndex + 1}-${endIndex} / ${filteredReports.length}`;

            // Sayfadaki raporları göster
            for (let i = startIndex; i < endIndex; i++) {
                const report = filteredReports[i];
                const isSuccess = report.success;
                const category = report.tags && report.tags.length > 0 ? report.tags[0] : 'default';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.name}</td>
                    <td><span class="test-category ${getCategoryClass(category)}">${category}</span></td>
                    <td class="text-center">${report.browserType || 'chromium'}</td>
                    <td class="text-center"><span class="badge ${isSuccess ? 'badge-success' : 'badge-danger'}">${isSuccess ? 'Başarılı' : 'Başarısız'}</span></td>
                    <td class="text-center">${formatDuration(report.duration)}</td>
                    <td class="text-center">${formatDate(report.timestamp)}</td>
                    <td class="text-center"><button class="btn btn-sm btn-info" onclick="showReportDetails('${report.id}')">Detaylar</button></td>
                `;

                tableBody.appendChild(row);
            }
        }

        // Sayfalama bilgilerini güncelle
        function updatePagination() {
            // Toplam sayfa sayısını hesapla
            totalPages = Math.ceil(filteredReports.length / pageSize);

            // Sayfa numaralarını oluştur
            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = '';

            // Önceki sayfa butonu
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Önceki" onclick="goToPage(${currentPage - 1}); return false;">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            pagination.appendChild(prevLi);

            // Sayfa numaraları
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            // Sonraki sayfa butonu
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Sonraki" onclick="goToPage(${currentPage + 1}); return false;">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Belirli bir sayfaya git
        function goToPage(page) {
            if (page < 1 || page > totalPages) {
                return;
            }

            currentPage = page;
            updateTable();
            updatePagination();
        }

        // Arama fonksiyonu
        function searchReports(query) {
            if (!query || query.trim() === '') {
                filteredReports = [...allReports];
            } else {
                query = query.toLowerCase();
                filteredReports = allReports.filter(report => {
                    return (
                        report.name.toLowerCase().includes(query) ||
                        (report.tags && report.tags.some(tag => tag.toLowerCase().includes(query))) ||
                        report.browserType.toLowerCase().includes(query)
                    );
                });
            }

            currentPage = 1;
            updatePagination();
            updateTable();
        }

        // Rapor detaylarını göster
        async function showReportDetails(reportId) {
            try {
                // Raporu al
                const response = await fetch(`/api/reports/${reportId}`);
                const report = await response.json();

                const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
                const modalContent = document.getElementById('testDetailsContent');

                // Adımları HTML'e dönüştür
                let stepsHtml = '';
                if (report.steps && report.steps.length > 0) {
                    stepsHtml = '<div class="steps-list">';
                    report.steps.forEach(step => {
                        const isStepSuccess = step.success;
                        stepsHtml += `
                            <div class="step-item ${isStepSuccess ? 'step-success' : 'step-error'}">
                                <div class="step-header">
                                    <span class="step-number">${step.step}.</span>
                                    <span class="step-action">${step.action}</span>
                                    <span class="step-status ${isStepSuccess ? 'text-success' : 'text-danger'}">
                                        <i class="bi ${isStepSuccess ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                                    </span>
                                </div>
                                <div class="step-details">
                                    <div><strong>Hedef:</strong> ${step.target || '-'}</div>
                                    <div><strong>Strateji:</strong> ${step.strategy || '-'}</div>
                                    <div><strong>Değer:</strong> ${step.value || '-'}</div>
                                    <div><strong>Açıklama:</strong> ${step.description || '-'}</div>
                                    <div><strong>Süre:</strong> ${formatDuration(step.duration)}</div>
                                    ${step.error ? `<div class="text-danger"><strong>Hata:</strong> ${step.error}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    stepsHtml += '</div>';
                } else {
                    stepsHtml = '<p>Bu test için adım bilgisi bulunmuyor.</p>';
                }

                // Modal içeriğini oluştur
                modalContent.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">${report.name}</h5>
                        </div>
                        <div class="card-body">
                            <div class="test-info">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Durum:</strong> <span class="badge ${report.success ? 'badge-success' : 'badge-danger'}">${report.success ? 'Başarılı' : 'Başarısız'}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tarayıcı:</strong> ${report.browserType}
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Süre:</strong> ${formatDuration(report.duration)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tamamlanma:</strong> ${formatDate(report.timestamp)}
                                    </div>
                                </div>
                            </div>
                            <h6>Test Adımları:</h6>
                            ${stepsHtml}
                        </div>
                    </div>
                `;

                modal.show();
            } catch (error) {
                console.error('Rapor detayları alınırken hata oluştu:', error);
            }
        }

        // Özetlerden grafikleri güncelle
        function updateChartsFromSummaries(summaries) {
            // Toplam test sayısı
            let totalTests = 0;
            let successfulTests = 0;
            let failedTests = 0;
            let totalDuration = 0;

            // Kategori dağılımı için
            const categories = {};

            // Test süreleri için
            const testDurations = [];

            summaries.forEach(summary => {
                totalTests += summary.totalTests;
                successfulTests += summary.successfulTests;
                failedTests += summary.failedTests;
                totalDuration += summary.averageDuration * summary.totalTests;

                // Kategori bilgilerini topla
                if (summary.categories) {
                    Object.keys(summary.categories).forEach(category => {
                        categories[category] = (categories[category] || 0) + summary.categories[category];
                    });
                }

                // Test sürelerini topla
                if (summary.tests) {
                    summary.tests.forEach(test => {
                        testDurations.push({
                            name: test.name,
                            duration: test.duration,
                            success: test.success
                        });
                    });
                }
            });

            // Başarı oranı
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) + '%' : '-';

            // Ortalama süre
            const avgDuration = totalTests > 0 ? formatDuration(totalDuration / totalTests) : '-';

            // Metrikleri güncelle
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('success-rate').textContent = successRate;
            document.getElementById('avg-duration').textContent = avgDuration;

            // Grafikleri güncelle
            updateTestResultsChartFromData(successfulTests, failedTests);
            updateCategoryChartFromData(categories);
            updateDurationChartFromData(testDurations);
        }

        // Test sonuçları grafiğini verilerden güncelle
        function updateTestResultsChartFromData(successCount, failedCount) {
            const ctx = document.getElementById('test-results-chart').getContext('2d');

            // Mevcut grafiği temizle
            if (window.testResultsChart) {
                window.testResultsChart.destroy();
            }

            // Yeni grafiği oluştur
            window.testResultsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Başarılı', 'Başarısız'],
                    datasets: [{
                        data: [successCount, failedCount],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = successCount + failedCount;
                                    const value = context.raw;
                                    const percentage = total > 0 ? Math.round(value / total * 100) : 0;
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Kategori grafiğini verilerden güncelle
        function updateCategoryChartFromData(categories) {
            const ctx = document.getElementById('category-chart').getContext('2d');

            // Eğer kategori yoksa varsayılan kategori ekle
            if (Object.keys(categories).length === 0) {
                categories['default'] = 1;
            }

            // Mevcut grafiği temizle
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }

            // Grafik verilerini oluştur
            const categoryLabels = Object.keys(categories);
            const categoryData = Object.values(categories);
            const backgroundColors = categoryLabels.map(category => getCategoryColor(category));

            // Yeni grafiği oluştur
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = categoryData.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = Math.round(value / total * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Süre grafiğini verilerden güncelle
        function updateDurationChartFromData(testDurations) {
            const ctx = document.getElementById('duration-chart').getContext('2d');

            // En son 10 testi al
            const recentTests = testDurations.slice(0, 10).reverse();

            // Mevcut grafiği temizle
            if (window.durationChart) {
                window.durationChart.destroy();
            }

            // Yeni grafiği oluştur
            window.durationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: recentTests.map(test => test.name),
                    datasets: [{
                        label: 'Test Süresi (saniye)',
                        data: recentTests.map(test => test.duration / 1000),
                        backgroundColor: recentTests.map(test => test.success ? '#4CAF50' : '#F44336'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Süre (saniye)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Test Adı'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Son 10 Test Süresi'
                        }
                    }
                }
            });
        }

        // Sayfa yüklendiğinde verileri al
        async function fetchInitialData() {
            const today = getTodayDate();
            document.getElementById('reportDate').value = today;
            const period = document.getElementById('reportPeriod').value || 'daily';

            // Günlük raporları yükle
            await loadDailyReportsTable();
        }

        // Sayfa yüklendiğinde çalıştır
        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();

            // Yenile butonu
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadDailyReportsTable();
            });

            // Tarih seçimi ve yükleme butonu
            document.getElementById('loadReportsBtn').addEventListener('click', () => {
                loadDailyReportsTable();
            });

            // Dönem değiştiğinde tarih formatını ayarla
            document.getElementById('reportPeriod').addEventListener('change', (e) => {
                const period = e.target.value;
                const dateInput = document.getElementById('reportDate');

                if (period === 'monthly') {
                    // Ay seçimi için
                    dateInput.type = 'month';
                } else {
                    // Gün seçimi için
                    dateInput.type = 'date';
                }
            });

            // Sayfa başına gösterim değiştiğinde
            document.getElementById('page-size-select').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                updatePagination();
                updateTable();
            });

            // Arama butonu
            document.getElementById('search-button').addEventListener('click', () => {
                const query = document.getElementById('search-input').value;
                searchReports(query);
            });

            // Arama input'u enter tuşu
            document.getElementById('search-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value;
                    searchReports(query);
                }
            });

            // Rapor indirme butonu
            document.getElementById('downloadReportBtn').addEventListener('click', () => {
                const modalContent = document.getElementById('testDetailsContent');
                const testName = modalContent.querySelector('.card-title').textContent;

                // HTML içeriğini JSON'a dönüştür
                const testData = {
                    name: testName,
                    html: modalContent.innerHTML,
                    date: new Date().toISOString()
                };

                // JSON'ı dosya olarak indir
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(testData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `${testName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            // Tarih alanını bugünün tarihiyle doldur
            document.getElementById('reportDate').value = getTodayDate();
        });

        // Fonksiyonları global olarak tanımla
        window.showTestDetails = showTestDetails;
        window.showReportDetails = showReportDetails;
        window.goToPage = goToPage;
        window.searchReports = searchReports;
    </script>
</body>
</html>
